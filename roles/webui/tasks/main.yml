---

- name: install nginx
  include_role:
    name: geerlingguy.nginx

- name: install webui
  pip:
    name:
      - django
      - gunicorn
      - mysqlclient
    virtualenv: /opt/webui_venv
    virtualenv_command: /bin/python3 -m venv
  register: webui_venv

- name: checkout webui
  git:
    repo: git://github.com/milliams/citc-webui.git
    dest: /opt/webui
    version: master

- name: Create webui group
  group:
    name: webui

- name: Create the webui user
  user:
    name: webui
    group: webui

# TODO make checkout readable only by correct user

- name: install gunicorn service file
  copy:
    src: gunicorn.service
    dest: /etc/systemd/system/gunicorn.service

- name: install gunicorn socket file
  copy:
    src: gunicorn.socket
    dest: /etc/systemd/system/gunicorn.socket

- name: start and enable gunicorn
  systemd:
    name: gunicorn
    state: started
    enabled: yes
    daemon_reexec: yes

- name: create webui database
  mysql_db:
    name: webui
    state: present

- name: create webui MySQL user
  mysql_user:
    name: webui
    password: "{{ webui_database_password }}"
    priv: 'webui.*:ALL'
    state: present

# TODO create secret key file https://docs.djangoproject.com/en/3.0/howto/deployment/checklist/#secret-key

- name: create webui mysql config
  template:
    src: my.cnf.j2
    dest: /etc/citc/webui.my.cnf
    owner: webui
    group: webui
    mode: "660"

- name: open HTTP port in firewall
  firewalld:
    service: http
    permanent: true
    state: enabled
  notify:
    - restart firewalld
