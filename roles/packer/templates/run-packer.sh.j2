#!/bin/bash

# {{ ansible_managed }}

export AWS_SHARED_CREDENTIALS_FILE="/home/slurm/aws-credentials.csv"

{% if ansible_local.citc.csp == "oracle" %}
if [[ "$1" == "gpu" ]] ; then
    /usr/local/bin/packer build \
        -var-file /etc/citc/packer/variables.pkrvars.hcl \
        -only="*.{{ ansible_local.citc.csp }}-gpu" \
        /etc/citc/packer/
{% endif %}
{% if ansible_local.citc.csp == "aws" %}
if [[ "$1" == "aarch64" ]] ; then
    /usr/local/bin/packer build \
        -var-file /etc/citc/packer/variables.pkrvars.hcl \
        -var arch=arm64 \
        -var instance_type=a1.medium \
        -only="*.{{ ansible_local.citc.csp }}" \
        /etc/citc/packer/
{% endif %}
else
    /usr/local/bin/packer build \
        -var-file /etc/citc/packer/variables.pkrvars.hcl \
        -only="*.{{ ansible_local.citc.csp }}" \
        /etc/citc/packer/
fi
