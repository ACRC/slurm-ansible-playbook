{
    "variables": {
        "source_image_family": "{{env `PACKER_source_image_family`}}",
        "account_file": "{{ env `PACKER_account_file` }}",
        "destination_image_name": "{{env `PACKER_destination_image_name`}}",
        "destination_image_family": "{{env `PACKER_destination_image_family`}}",
        "project_id": "{{env `PACKER_project_id`}}",
        "zone": "{{env `PACKER_zone`}}",
        "region": "{{env `PACKER_region`}}",
        "network": "{{env `PACKER_network`}}",
        "subnetwork": "{{env `PACKER_subnetwork`}}",
        "petname": "{{env `PACKER_petname`}}"
    },
    "builders": [
        {
            "type": "googlecompute",
            "name": "google",
            "account_file": "{{ user `account_file` }}",
            "source_image_family": "{{user `source_image_family`}}",
            "ssh_username": "centos",
            "project_id": "{{user `project_id`}}",
            "zone": "{{user `zone`}}",
            "network": "{{user `network`}}-{{user `petname`}}",
            "subnetwork": "{{user `subnetwork`}}-{{user `petname`}}",
            "use_internal_ip": true,
            "tags": "compute-{{user `petname`}}",
            "image_name": "{{user `destination_image_name`}}-{{user `petname`}}-v{{timestamp}}",
            "image_family": "{{user `destination_image_family`}}-{{user `petname`}}",
            "labels": {
                "cluster": "{{user `petname`}}"
            },
            "image_labels": {
                "cluster": "{{user `petname`}}"
            }
        },
        {
            "type": "amazon-ebs",
            "name": "aws",
            "ami_name": "{{user `destination_image_name`}}-{{user `petname`}}-v{{timestamp}}",
            "run_volume_tags": {
                "cluster": "{{user `petname`}}"
            },
            "tags": {
                "cluster": "{{user `petname`}}"
            },
            "snapshot_tags": {
                "cluster": "{{user `petname`}}"
            },
            "run_tags": {
                "cluster": "{{user `petname`}}"
            },
            "force_deregister": true,
            "force_delete_snapshot": true,
            "region": "{{user `region`}}",
            "instance_type": "t2.nano",
            "source_ami_filter": {
              "filters": {
                "product-code": "aw0evgkw8e5c1q413zgy5pjce",
                "architecture": "x86_64"
              },
              "owners": ["679593333241"],
              "most_recent": true
            },
            "ssh_username": "centos",
            "vpc_filter": {
                "filters": {
                    "tag:cluster": "{{user `petname`}}"
                }
            },
            "subnet_filter": {
                "filters": {
                    "tag:cluster": "{{user `petname`}}"
                }
            },
            "associate_public_ip_address": true
        }
    ],
    "provisioners": [
        {
            "type": "file",
            "source": "/home/citc/.ssh/authorized_keys",
            "destination": "/tmp/citc_authorized_keys"
        },
        {
            "type": "shell",
            "script": "/etc/citc/packer/run_ansible.sh"
        }
    ]
}
