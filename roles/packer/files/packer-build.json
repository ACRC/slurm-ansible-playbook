{
    "variables": {
        "source_image_family": "{{env `PACKER_source_image_family`}}",
        "account_file": "{{ env `PACKER_account_file` }}",
        "destination_image_name": "{{env `PACKER_destination_image_name`}}",
        "destination_image_family": "{{env `PACKER_destination_image_family`}}",
        "project_id": "{{env `PACKER_project_id`}}",
        "zone": "{{env `PACKER_zone`}}",
        "region": "{{env `PACKER_region`}}",
        "csp": "{{env `PACKER_csp`}}",
        "fileserver_ip": "{{env `PACKER_fileserver_ip`}}",
        "network": "{{env `PACKER_network`}}",
        "subnetwork": "{{env `PACKER_subnetwork`}}",
        "branch": "{{env `PACKER_branch`}}",
        "petname": "{{env `PACKER_petname`}}"
    },
    "builders": [
        {
            "type": "googlecompute",
            "name": "google",
            "account_file": "{{ user `account_file` }}",
            "source_image_family": "{{user `source_image_family`}}",
            "ssh_username": "centos",
            "project_id": "{{user `project_id`}}",
            "zone": "{{user `zone`}}",
            "network": "{{user `network`}}-{{user `petname`}}",
            "subnetwork": "{{user `subnetwork`}}-{{user `petname`}}",
            "use_internal_ip": true,
            "tags": "compute-{{user `petname`}}",
            "image_name": "{{user `destination_image_name`}}-{{user `petname`}}-v{{timestamp}}",
            "image_family": "{{user `destination_image_family`}}-{{user `petname`}}",
            "labels": {
                "cluster": "{{user `petname`}}"
            },
            "image_labels": {
                "cluster": "{{user `petname`}}"
            }
        },
        {
            "type": "amazon-ebs",
            "name": "aws",
            "ami_name": "{{user `destination_image_name`}}-{{user `petname`}}-v{{timestamp}}",
            "run_volume_tags": {
                "cluster": "{{user `petname`}}"
            },
            "tags": {
                "cluster": "{{user `petname`}}"
            },
            "snapshot_tags": {
                "cluster": "{{user `petname`}}"
            },
            "run_tags": {
                "cluster": "{{user `petname`}}"
            },
            "force_deregister": true,
            "force_delete_snapshot": true,
            "region": "{{user `region`}}",
            "instance_type": "t2.nano",
            "source_ami_filter": {
              "filters": {
                "product-code": "aw0evgkw8e5c1q413zgy5pjce",
                "architecture": "x86_64"
              },
              "owners": ["679593333241"],
              "most_recent": true
            },
            "ssh_username": "centos",
            "vpc_filter": {
                "filters": {
                    "tag:cluster": "{{user `petname`}}"
                }
            },
            "subnet_filter": {
                "filters": {
                    "tag:cluster": "{{user `petname`}}"
                }
            },
            "associate_public_ip_address": true
        }
    ],
    "provisioners": [
        {
            "type": "file",
            "source": "/home/citc/.ssh/authorized_keys",
            "destination": "/tmp/citc_authorized_keys"
        },
        {
            "type": "shell",
            "inline": [
                "echo 'packer' | sudo -S sh -c ' ",
                "cat > /tmp/hosts <<EOF",
                "[compute]",
                "$(hostname)",
                "[all:vars]",
                "cluster_id={{user `petname`}}",
                "packer_run=yes",
                "EOF'",
                "sudo yum install -y ansible git",
                "sudo cat /tmp/hosts",
                "sudo mkdir -p /etc/ansible/facts.d/",
                "echo 'packer' | sudo -S sh -c '",
                "cat > /etc/ansible/facts.d/citc.fact <<EOF",
                "{\"csp\":\"{{user `csp` }}\", \"fileserver_ip\":\"{{user `fileserver_ip`}}\", \"mgmt_hostname\":\"{{user `mgmt_hostname`}}\" }",
                "EOF'",
                "sudo cat /etc/ansible/facts.d/citc.fact",
                "sudo mv /tmp/citc_authorized_keys /root/citc_authorized_keys",
                "sudo /usr/bin/ansible-pull --url=https://github.com/ACRC/slurm-ansible-playbook.git --checkout={{ user `branch` }} --inventory=/tmp/hosts compute.yml"
            ]
        }
    ]
}
